{% extends "innerbase_copy.html" %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}
{% load static %}

{% block css_link %}
<link rel="stylesheet" href="{% static 'sales_tracker/agentemail.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
{% endblock %}

{% block title %}Compose Email{% endblock %}

{% block content %}
<div class="container-fluid">
    <form id="emailForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="row mt-2 mb-2">
            <div class="col-12 text-center moving_title" style="color: white;">
                Compose Email
            </div>
        </div>

        <div class="row mt-3">

            <div class="row mt-1 mb-2">
                <div class="col-12 d-flex justify-content-end mb-5">
                    <button type="submit" class="btn btn-primary mx-2">
                        <i class="fas fa-paper-plane"></i>
                        <span class="button-label">Send</span>
                    </button>
                    <button type="button" class="btn btn-secondary mx-2" onclick="cancelAction()">
                        <i class="fas fa-times"></i>
                        <span class="button-label">Cancel</span>
                    </button>
    
                    <input type="file" id="fileInput" style="display: none;" multiple onchange="handleFiles(this.files)">
                    <button type="button" class="btn btn-info mx-2" onclick="document.getElementById('fileInput').click();">
                        <i class="fas fa-paperclip"></i>
                        <span class="button-label">Attach Files</span>
                    </button>
    
                    <input type="file" id="documentInput" style="display: none;" multiple
                        onchange="handleDocuments(this.files)">
                    <button type="button" class="btn btn-info mx-2"
                        onclick="document.getElementById('documentInput').click();">
                        <i class="fas fa-file-upload"></i>
                        <span class="button-label">Attach Documents</span>
                    </button>
    
                    <button type="button" class="btn btn-warning mx-2" onclick="saveDraft()">
                        <i class="fas fa-save"></i>
                        <span class="button-label">Save Draft</span>
                    </button>
                    <button type="button" class="btn btn-danger mx-2" onclick="deleteEmail()">
                        <i class="fas fa-trash"></i>
                        <span class="button-label">Delete</span>
                    </button>
                </div>
            </div>

            
            <div class="col-md-6 pt-5 pb-5 px-4" style="color: rgb(15, 14, 14);">
                <div class="form-group mb-5">
                    {{ form.template|as_crispy_field }}
                </div>

                <div class="form-group mb-5">
                    {{ form.related_to|as_crispy_field }}
                </div>

                <div class="form-group mb-5">
                    {{ form.from_address|as_crispy_field }}
                </div>

                <div class="form-group mb-5">
                    {{ form.to_address|as_crispy_field }}
                </div>

                <div class="form-group mb-5">
                    {{ form.cc_address|as_crispy_field }}
                </div>

                <div class="form-group mb-5">
                    {{ form.bcc_address|as_crispy_field }}
                </div>
            </div>

            <div class="col-md-6 pt-5 pb-5 px-4"
                style="color: rgb(15, 14, 14); border-left: 1px solid rgb(15, 14, 14);">
                <div class="form-group mb-5">
                    {{ form.subject|as_crispy_field }}
                </div>

                <div class="form-group mb-5">
                    <label for="editor" class="control-label">Body</label>
                    <div id="editor"
                        style="border: 1px solid #ced4da; padding: 10px; min-height: 200px; resize: vertical; background-color:  #f8f9fa;">
                    </div>
                    <textarea name="body" id="id_body" style="display:none;"></textarea>
                </div>

                <div class="form-group mb-5">
                    {{ form.send_plain_text|as_crispy_field }}
                </div>
            </div>
        </div>

        
    </form>
</div>

{% endblock %}

{% block javascript %}
<script>

    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Compose your email here...',
        modules: {
            toolbar: [
                [{ 'font': [] }, { 'size': [] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'script': 'super' }, { 'script': 'sub' }],
                [{ 'align': [] }],
                ['link', 'image', 'blockquote', 'code-block'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'indent': '-1' }, { 'indent': '+1' }],
                [{ 'direction': 'rtl' }]
            ]
        }
    });
    document.getElementById('emailForm').addEventListener('submit', function (event) {
        document.getElementById('id_body').value = quill.root.innerHTML;
    });

    function cancelAction() {
        if (confirm('Are you sure you want to cancel?')) {
            window.location.href = '/dashboard';
        }
    }

    function saveDraft() {
        const formData = new FormData(document.getElementById('emailForm'));

        fetch('/save-draft-endpoint/', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Draft saved successfully!');
                } else {
                    alert('Error saving draft: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error saving your draft.');
            });
    }

    function handleFiles(files) {
        for (const file of files) {
            console.log('File attached:', file.name);
        }
    }

    function handleDocuments(files) {
        for (const file of files) {
            console.log('Document attached:', file.name);
        }
    }

    function deleteEmail() {
        if (confirm('Are you sure you want to delete this email?')) {
            alert('Email deleted!');
        }
    }
</script>
{% endblock %}